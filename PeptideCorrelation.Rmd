---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Import packages

```{r}
library(Hmisc)
library(scp)
library(scpdata)
library(dplyr)
library(ggplot2)
library(tidyr)
```

# Load data

```{r}
# View(as.data.frame(scpdata())) # Available data sets
scp <- specht2019v3() # Load data
```

# Within peptides of a same protein

```{r}
df <- as.data.frame(rowData(scp[["peptides"]]))

peptide_assay <- assay(scp[["peptides"]])

all_cor_df <- DataFrame()

for (protein in rownames(assay(scp[["proteins"]]))) {
  
  peptides <- as.vector(df[, "peptide"][df[, "protein"] == protein])
  sub_pep_assay <- peptide_assay[peptides, ]
  
  if (length(peptides) >= 2) {
    res <- rcorr(t(sub_pep_assay), type = "pearson")
    ind <- which(upper.tri(res$r), arr.ind = TRUE)
    nn <- dimnames(res$r)
    temp_df <- data.frame(protein = rep(protein, length(ind)),
                          peptide1 = nn[[1]][ind[, 1]],
                          peptide2 = nn[[2]][ind[, 2]],
                          r = res$r[ind],
                          p = res$P[ind])
    all_cor_df <- rbind(all_cor_df, temp_df)
  }
}

# Clean dataframe
all_cor_df <- all_cor_df[!duplicated(all_cor_df), ]
all_cor_df <- all_cor_df[!is.na(all_cor_df[c(5)]), ]
all_cor_df <- all_cor_df[all_cor_df$p != 0, ]

# all_cor_df$adj_p <- p.adjust(all_cor_df$p, method = "BH")
all_cor_df <- all_cor_df[all_cor_df$p <= 0.05, ]
all_cor_df <- as.data.frame(all_cor_df)
```

# Plot

```{r}
ggplot() + aes(all_cor_df$r)+ geom_histogram(binwidth = 0.1,
                                        colour = "black", fill = "white") +
  ylim(0, 3500)

View(all_cor_df)
```

# Functions to identify anti-correlated peptides

```{r}
listPos <- function(df, neg = FALSE) {
  all_peps <- unique(c(df$peptide1, df$peptide2))
  res <- c()
  for (pep in all_peps) {
    if (neg == TRUE) {
      if (all(df[(df$peptide1 == pep) | (df$peptide2 == pep), ]$r < 0)) {
      res <- c(res, pep)
      
      }
    } else {
      if (all(df[(df$peptide1 == pep) | (df$peptide2 == pep), ]$r > 0)) {
      res <- c(res, pep)
      }
    }
  }
  return (res)
}
```

# Filter anti-correlated

```{r}
# Identify anti-correlated peptides
to_be_removed <- c()

for (protein in unique(all_cor_df$protein)) {
    # All peps of a protein
    sub_all <- all_cor_df[all_cor_df$protein == protein, ]
    
    ### Peptides having only positive correlation ###
    pos_peptides <- listPos(sub_all)

    # Extend these peptides with their correlation partners
    sub_pos <- subset(sub_all, (peptide1 %in% pos_peptides) |
                               (peptide2 %in% pos_peptides))
    pos_peptides <- unique(c(sub_pos$peptide1, sub_pos$peptide2))
    
    
    ### Peptides having only negative correlation ###
    neg_peptides <- listPos(sub_all, neg = TRUE)
    
    to_be_removed <- c(to_be_removed, neg_peptides)
    
    # Extend these peptides with their correlation partners
    sub_neg <- subset(sub_all, (peptide1 %in% neg_peptides) |
                               (peptide2 %in% neg_peptides))
    
    # Correlation partners of neg_peptides should be pos_peptides
    neg_peptides2 <- unique(c(sub_neg$peptide1, sub_neg$peptide2))
    pos_peptides <- c(pos_peptides, setdiff(neg_peptides2, neg_peptides))
    
    # Extend further with all possible
    for (i in 1:5) {
      sub_pos <- subset(sub_all, ((peptide1 %in% pos_peptides) | (peptide2 %in% pos_peptides)) & r > 0)
    
      pos_peptides <- unique(c(pos_peptides, c(sub_pos$peptide1, sub_pos$peptide2)))
    }
    
    # Determine peptides can be removed
    sub_all <- subset(sub_all, (peptide1 %in% pos_peptides) |
                               (peptide2 %in% pos_peptides))
    
    suspects <- unique(c(sub_all[sub_all$r < 0, ]$peptide1, 
                         sub_all[sub_all$r < 0, ]$peptide2))
    
    to_be_removed <- c(to_be_removed, setdiff(suspects, pos_peptides))
}

```

```{r}
length(unique(to_be_removed))

all_cleaned <- subset(all_cor_df, !((peptide1 %in% to_be_removed) |
                               (peptide2 %in% to_be_removed)))

# Histogram of removed peptides' correlations
ggplot() + aes(setdiff(all_cor_df, all_cleaned)$r)+ geom_histogram(binwidth = 0.1,
                                        colour = "black", fill = "white") +
  ylim(0, 200)
```

# Correlation change after removing anti-correlated peptides

```{r}
scp <- specht2019v3()

scp <- aggregateFeaturesOverAssays(scp, i = "peptides", fcol = "protein", 
                                    name = "old_proteins", fun = colMedians)

prots_altered <- rowData(scp[["peptides"]][rowData(scp[["peptides"]])$peptide %in% to_be_removed, ])$protein

scp[["peptides2"]] <- scp[["peptides"]][!(rowData(scp[["peptides"]])$peptide %in% to_be_removed), ]

scp <- aggregateFeaturesOverAssays(scp, i = "peptides2", fcol = "protein", 
                                    name = "new_proteins", fun = colMedians)

df_new <- assay(scp[["new_proteins"]])
df_new <- df_new[rownames(df_new) %in% prots_altered, ]

df_old <- assay(scp[["old_proteins"]])
df_old <- df_old[rownames(df_old) %in% rownames(df_new), ]

res <- rcorr(t(df_old), type = "pearson")
cor_old <- res$r
diag(cor_old) <- NA

res <- rcorr(t(df_new), type = "pearson")
cor_new <- res$r
diag(cor_new) <- NA

old_vals <- cor_old[!is.na(cor_old)]

new_vals <- cor_new[!is.na(cor_new)]

old_df <- data.frame(r = old_vals,
                     type = rep("All Peptides", length(old_vals)))

new_df <- data.frame(r = new_vals,
                     type = rep("Removed Peptides", length(new_vals)))

ggplot(rbind(old_df, new_df), aes(y = r, x = as.factor((type)))) + 
    geom_boxplot() +
    geom_jitter(color = "black", size = 0.5, alpha = 1) +
    theme_classic()
```

