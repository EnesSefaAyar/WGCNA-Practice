---
output: html_document
editor_options: 
chunk_output_type: console
---

# Install

```{r. eval = FALSE}
install.packages('WGCNA')
BiocManager::install("UniProt.ws")
install.packages("enrichR")
```

# Import

```{r}
library(WGCNA)
library(scp)
library(scpdata)
library(ggplot2)
library(gridExtra)
library(UniProt.ws)
library(enrichR)
```

# Load data

```{r}
# View(as.data.frame(scpdata())) # Available data sets

scp <- specht2019v3() # Load specific data set

# Subset same type of cells
scp_sub <- getWithColData(scp, "proteins")
scp_sub <- scp_sub[, scp_sub$SampleType == "Macrophage" & scp_sub$lcbatch == "LCB7"]
dim(scp_sub) # check dimensions

# Extract assay only
df_WGCNA <- assay(scp_sub)

# Highly Variable features
var <- apply(df_WGCNA, 1, var)
df_WGCNA <- df_WGCNA[var >= quantile(var, 0.7), ]
dim(df_WGCNA)

corr <- rcorr(t(df_WGCNA[, ]), type = "pearson")

cor_df <- corr$r
cor_df[corr$P > 0.01 & abs(corr$r) > 0.3] <- 0

# Explore
# hist(df_CPM[, 3])
apply(df_WGCNA, 1, hist)
```

# Soft Threshold

```{r}
powers <- c(seq(from = 1, to = 30, by = 0.5))
sft <- pickSoftThreshold(t(df_WGCNA),
                  powerVector = powers,
                  networkType = "signed",
                  verbose = 5)

sft_data <- sft$fitIndices
 
p1 <- ggplot(sft_data, aes(Power, SFT.R.sq, label = Power)) +
  geom_point() +
  geom_hline(yintercept = 0.8, color = "red") +
  labs( x = "Power", y = "Scale free topology model fit, signed R^2") +
  theme_classic()

p2 <- ggplot(sft_data, aes(Power, mean.k., label = Power)) +
  geom_point() +
  geom_text(nudge_y = 0.1) +
  labs(x = "Power", y = "Mean Connectivity") +
  theme_classic()

grid.arrange(p1, p2)

```

# Module detection

```{r}
temp_cor <- cor
cor <- WGCNA::cor

# Build a adjacency "correlation" matrix, sft$powerEstimate
adjacency <- adjacency(t(df_WGCNA[, ]), power = 6, type = "signed") #specify network type

TOM <- TOMsimilarity(adjacency, TOMType = "signed") # specify network type
rownames(TOM) <- rownames(adjacency)
colnames(TOM) <- colnames(adjacency)

View(TOM)

dissTOM <- 1 - TOM

# Generate a clustered gene tree
geneTree <- hclust(as.dist(dissTOM), method = "average")

#This sets the minimum number of genes to cluster into a module
dynamicMods <- cutreeDynamic(geneTree, minClusterSize = 5)

dynamicColors <- labels2colors(dynamicMods)

plotDendroAndColors(geneTree, dynamicColors, 
                    c("Dynamic Tree Cut"),
                    dendroLabels = FALSE, hang = 0.03, 
                    addGuide = TRUE, guideHang = 0.05)

clusters_WGCNA <- as.data.frame(dynamicMods)
```

# Enrichment

```{r}
table(clusters_WGCNA)

cluster_members_WGCNA <- rownames(cor_df)[clusters_WGCNA == 7]
length(cluster_members_WGCNA)

# Map to Gene names
up <- UniProt.ws(taxId = 9606)
res <- select(
    x = up,
    keys = cluster_members_WGCNA,
    to = "Gene_Name"
)

# Subplot of module correlation
temp_df <- cor_df[cluster_members_WGCNA, cluster_members_WGCNA]
if (length(res$To) == length(rownames(temp_df))){
  rownames(temp_df) <- res$To 
  colnames(temp_df) <- res$To 
}
pheatmap(temp_df,
         color = colorRampPalette(c("#4d72af", "white", "#c44e53")) (101),
         breaks = seq(from = -1, to = 1, length.out = 101),
         border_color = NA,legend = FALSE, show_colnames = TRUE, 
         show_rownames = TRUE,
         cluster_rows = FALSE, cluster_cols = FALSE,
         cellwidth = 450/nrow(temp_df), cellheight = 450/nrow(temp_df),
         fontfamily = 'sans', fontsize = 10,
         display_numbers = round(temp_df, 2))


# List of databases
# View(listEnrichrDbs())

dbs <- c("WikiPathway_2023_Human", "GO_Biological_Process_2023", "KEGG_2021_Human")
enriched_WGCNA <- enrichr(res$To, dbs)
plotEnrich(enriched_WGCNA[[3]], showTerms = 10, numChar = 40, y = "Ratio")

```

