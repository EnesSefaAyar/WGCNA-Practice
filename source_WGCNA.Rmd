---
output: html_document
editor_options: 
chunk_output_type: console
---

# Install

```{r. eval = FALSE}
install.packages('WGCNA')
BiocManager::install("UniProt.ws")
install.packages("enrichR")
install.packages("expm", repos="http://R-Forge.R-project.org")
```

# Import

```{r}
library(WGCNA)
library(scp)
library(scpdata)
library(ggplot2)
library(gridExtra)
library(UniProt.ws)
library(enrichR)
library(Hmisc)
library(pheatmap)
library(expm)
```

# Load data

```{r}
# View(as.data.frame(scpdata())) # Available data sets

scp <- specht2019v3() # Load specific data set

# Subset same type of cells
scp_sub <- getWithColData(scp, "proteins")
scp_sub <- scp_sub[, scp_sub$SampleType == "Macrophage" & scp_sub$lcbatch == "LCB7"]

dim(scp_sub) # check dimensions

# Extract assay only
df_WGCNA <- assay(scp_sub)

# corr <- rcorr(t(df_WGCNA[, ]), type = "pearson")
# cor_df <- corr$r

# Highly Variable features
var <- apply(df_WGCNA, 1, var)
df_WGCNA <- df_WGCNA[var >= quantile(var, 0.5), ]
dim(df_WGCNA)

cor_df <- cor(t(df_WGCNA[, ]), method = "pearson")

# Explore
# hist(df_CPM[, 3])
# apply(df_WGCNA, 1, hist)
```

# Soft Threshold

```{r}
powers <- c(seq(from = 1, to = 20, by = 0.1))
sft <- pickSoftThreshold(t(df_WGCNA),
                  powerVector = powers,
                  networkType = "signed",
                  RsquaredCut = 0.9,
                  verbose = 5)

sft_data <- sft$fitIndices
 
p1 <- ggplot(sft_data, aes(Power, SFT.R.sq, label = Power)) +
  geom_point() +
  geom_hline(yintercept = 0.9, color = "red") +
  labs( x = "Power", y = "Scale free topology model fit, signed R^2") +
  theme_classic()

p2 <- ggplot(sft_data, aes(Power, mean.k., label = Power)) +
  geom_point() +
  geom_text(nudge_y = 0.1) +
  labs(x = "Power", y = "Mean Connectivity") +
  theme_classic()

grid.arrange(p1, p2)
```

# Module detection

```{r}
temp_cor <- cor
cor <- WGCNA::cor

adjacency <- adjacency(t(df_WGCNA), power = sft$powerEstimate, type = "signed") 

TOM <- TOMsimilarity(adjacency, TOMType = "signed")
rownames(TOM) <- rownames(cor_df)
colnames(TOM) <- colnames(cor_df)

dissTOM <- 1 - TOM

# Generate a clustered gene tree
geneTree <- hclust(as.dist(dissTOM), method = "average")

#This sets the minimum number of genes to cluster into a module
dynamicMods <- cutreeDynamic(geneTree, minClusterSize = 15)

dynamicColors <- labels2colors(dynamicMods)

plotDendroAndColors(geneTree, dynamicColors,
                    c("Dynamic Tree Cut"),
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05)

clusters_WGCNA <- as.data.frame(dynamicMods)
```

# Select Cluster

```{r}
table(clusters_WGCNA)

cluster_members_WGCNA <- rownames(df_WGCNA)[clusters_WGCNA == 2]
length(cluster_members_WGCNA)

# Map to Gene names
up <- UniProt.ws(taxId = 9606)
res <- select(
    x = up,
    keys = cluster_members_WGCNA,
    to = "Gene_Name"
)
```

# Enrichment

```{r}
# List of databases
# View(listEnrichrDbs())

dbs <- c("WikiPathway_2023_Human", "GO_Molecular_Function_2023", "KEGG_2021_Human")
enriched_WGCNA <- enrichr(res$To, dbs)
plotEnrich(enriched_WGCNA[[3]], showTerms = 10, numChar = 40, y = "Ratio")
```

# Analyze Clusters

```{r}
mems <- strsplit(enriched_WGCNA[[3]][1, "Genes"], ";")[[1]]

# View(enriched_WGCNA[[3]])
mems
new_mems <- c()
for (i in 1:length(res$To)) {
  if (res$To[i] %in% mems) {
    new_mems <- c(new_mems,(res$From[i]))
  }
}

temp_df <- cor_df[new_mems, new_mems]

pheatmap(temp_df,
         color = colorRampPalette(c("#4d72af", "white", "#c44e53")) (101),
         breaks = seq(from = -1, to = 1, length.out = 101),
         border_color = NA,legend = FALSE, show_colnames = FALSE,
         show_rownames = FALSE,
         cluster_rows = FALSE, cluster_cols = FALSE,
         cellwidth = 450/nrow(temp_df), cellheight = 450/nrow(temp_df),
         fontfamily = 'sans', fontsize = 10)

```


